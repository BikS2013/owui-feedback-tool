# OWUI Feedback CLI

A command-line tool for extracting questions from conversation threads.

## Installation

```bash
npm install
npm run build
```

## Configuration

Create a `.env` file based on `.env.example`:

```bash
API_BASE_URL=http://localhost:3120

# System Prompts Configuration (optional)
# TOPIC_IDENTIFICATION_PROMPT: Filename of the topic identification prompt in system prompts
TOPIC_IDENTIFICATION_PROMPT=topic-identification.txt
```

### System Prompts Integration

The CLI can fetch the topic identification prompt from the backend's System Prompts API. If the `TOPIC_IDENTIFICATION_PROMPT` environment variable is set, the CLI will:

1. Try to fetch the prompt template from the System Prompts API
2. If successful, use the template for topic identification
3. If failed or not configured, fall back to the hardcoded prompts

This allows you to maintain and update prompts centrally without modifying the CLI code.

## Usage

### Get Threads

Retrieve complete thread data with optional checkpoints:

```bash
# Basic usage - threads only
npx tsx src/index.ts get_threads -f 2024-01-01 -t 2024-01-31 -a "Customer Facing"

# Include checkpoint data
npx tsx src/index.ts get_threads -f 2024-01-01 -t 2024-01-31 -a "Customer Facing" --include-checkpoints

# Save to file (incremental saving, page by page)
npx tsx src/index.ts get_threads -f 2024-01-01 -t 2024-01-31 -a "Customer Facing" -o threads.json
```

### Extract Questions from Threads File

Extract questions from an existing threads JSON file:

```bash
# Extract questions from threads.json
npx tsx src/index.ts extract_questions -i threads.json -o questions.json

# With debug logging
DEBUG=1 npx tsx src/index.ts extract_questions -i threads.json -o questions.json
```

### Extract Questions (from API)

Extract all user questions from conversations within a date range.

#### Date Format Support

The tool accepts various date formats:
- **Basic date**: `YYYY-MM-DD` (e.g., `2024-01-15`)
- **Date with time**: `YYYY-MM-DDTHH:mm:ss` (e.g., `2024-01-15T14:30:00`)
- **With UTC timezone**: `YYYY-MM-DDTHH:mm:ssZ` (e.g., `2024-01-15T14:30:00Z`)
- **With offset**: `YYYY-MM-DDTHH:mm:ss+HH:mm` (e.g., `2024-01-15T14:30:00+02:00`)
- **Any ISO 8601 format**

#### Examples

```bash
# Basic usage (date only)
npx tsx src/index.ts get_questions --from-date 2024-01-01 --to-date 2024-01-31

# With specific time range
npx tsx src/index.ts get_questions -f 2024-01-01T00:00:00Z -t 2024-01-31T23:59:59Z

# Filter by agent name
npx tsx src/index.ts get_questions -f 2024-01-01 -t 2024-01-31 -a "agent-name"

# Save to file
npx tsx src/index.ts get_questions -f 2024-01-01 -t 2024-01-31 -o questions.json
```

### Output Format

The tool outputs a JSON array with the following structure:

```json
[
  {
    "conversationId": "thread-123",
    "conversationTimestamp": "2024-01-15T10:30:00Z",
    "questionOrder": 1,
    "totalQuestionsInThread": 2,
    "questionText": "How do I configure the API endpoint?"
  },
  {
    "conversationId": "thread-123",
    "conversationTimestamp": "2024-01-15T10:30:00Z",
    "questionOrder": 2,
    "totalQuestionsInThread": 2,
    "questionText": "What are the authentication requirements?"
  }
]
```

### Identify Topics

Use an LLM to identify and classify topics from questions with thread context:

```bash
# Identify topics for all questions
npx tsx src/index.ts identify_topics -i questions.json -o topics.json -l "gpt-4"

# Process only first 50 questions
npx tsx src/index.ts identify_topics -i questions.json -o topics.json -l "gpt-4" -f 50

# Use predefined topics as initial topic list
npx tsx src/index.ts identify_topics -i questions.json -o topics.json -l "gpt-4" -t initial-topics.json

# List available LLM configurations
# The command will show available configurations if the specified one is not found
```

#### Key Features

- **Thread-Aware Classification**: Processes questions within their conversation threads
- **Context-Aware**: Each question is classified considering previous questions in the thread
- **Single vs Multi-Topic Threads**: Identifies if all questions in a thread relate to one topic or multiple topics
- **Progressive Context**: For multi-question threads, each question is analyzed with the context of all previous questions
- **Low Temperature**: Uses temperature 0.1 for consistent topic identification
- **Initial Topics Support**: Can load predefined topics with descriptions from a JSON file
- **Topic Descriptions**: All topics include descriptions - either from initial topics or generated by the LLM

#### Initial Topics Format

The initial topics file should follow this format:

```json
{
  "topics": [
    {
      "topic": "Technical Support",
      "description": "Questions related to technical issues, debugging, error resolution, and system troubleshooting"
    },
    {
      "topic": "Feature Request",
      "description": "Questions about new features, enhancements, or suggestions for product improvements"
    }
  ]
}
```

#### Output Format

The tool outputs thread classifications and topic summaries:

```json
{
  "threadClassifications": [
    {
      "conversationId": "thread-123",
      "conversationTimestamp": "2024-01-15T10:30:00Z",
      "threadTopic": "Account Management",  // Present if all questions have same topic
      "questionTopics": [
        {
          "questionOrder": 1,
          "questionText": "How do I change my password?",
          "topic": "Account Management"
        },
        {
          "questionOrder": 2,
          "questionText": "Can I update my email address?",
          "topic": "Account Management"
        }
      ]
    },
    {
      "conversationId": "thread-456",
      "conversationTimestamp": "2024-01-15T11:00:00Z",
      // No threadTopic since questions have different topics
      "questionTopics": [
        {
          "questionOrder": 1,
          "questionText": "Why was my payment declined?",
          "topic": "Payment Issues"
        },
        {
          "questionOrder": 2,
          "questionText": "How do I change my address?",
          "topic": "Account Management"
        }
      ]
    }
  ],
  "topicSummary": {
    "Account Management": {
      "threads": ["thread-123", "thread-456"],
      "questions": [
        {
          "conversationId": "thread-123",
          "questionOrder": 1,
          "questionText": "How do I change my password?"
        },
        {
          "conversationId": "thread-123",
          "questionOrder": 2,
          "questionText": "Can I update my email address?"
        },
        {
          "conversationId": "thread-456",
          "questionOrder": 2,
          "questionText": "How do I change my address?"
        }
      ]
    },
    "Payment Issues": {
      "threads": ["thread-456"],
      "questions": [
        {
          "conversationId": "thread-456",
          "questionOrder": 1,
          "questionText": "Why was my payment declined?"
        }
      ]
    }
  },
  "topicsUsed": {
    "Account Management": {
      "description": "Questions related to managing user accounts, profiles, and settings",
      "source": "initial"
    },
    "Payment Issues": {
      "description": "Questions about payment processing, billing, and transaction problems",
      "source": "llm-generated"
    }
  },
  "metadata": {
    "totalThreads": 2,
    "totalQuestions": 4,
    "totalTopics": 2,
    "llmUsed": "gpt-4",
    "processedAt": "2024-01-15T12:00:00Z"
  }
}
```

## Development

```bash
# Run in development mode
npm run dev get_questions -f 2024-01-01 -t 2024-01-31

# Build for production
npm run build

# Run built version
npm start get_questions -f 2024-01-01 -t 2024-01-31
```